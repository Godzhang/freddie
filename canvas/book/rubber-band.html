<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../reset.css" />
    <script src="../public/utils.js"></script>
    <style>
      body {
        background-color: #eee;
      }
      #controls {
        position: absolute;
        top: 25px;
        left: 25px;
      }
      #canvas {
        background-color: #fff;
        cursor: pointer;
        margin: 60px 0 0 10px;
        box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
      }
    </style>
    <title>book-study</title>
  </head>

  <body>
    <canvas id="canvas" width="600" height="400"></canvas>
    <div id="controls">
      Stroke color:
      <select id="strokeStyleSelect">
        <option value="red">red</option>
        <option value="green">green</option>
        <option value="blue">blue</option>
        <option value="cornflowerblue">cornflowerblue</option>
        <option value="OrangeRed" selected>OrangeRed</option>
        <option value="navy">navy</option>
      </select>
      Guidewires:
      <input id="guidewireCheckbox" type="checkbox" checked />
      <input id="eraseAllButton" type="button" value="Erase all" />
    </div>
    <script>
      //
      const canvasWidth = 600;
      const canvasHeight = 400;
      const canvas = document.getElementById("canvas");
      const context = canvas.getContext("2d");
      const eraseAllButton = document.getElementById("eraseAllButton");
      const strokeStyleSelect = document.getElementById("strokeStyleSelect");
      const guidewireCheckbox = document.getElementById("guidewireCheckbox");
      const mousedown = {};
      const rubberbandRect = {};
      const guidewires = guidewireCheckbox.checked;
      let drawingSurfaceImageData;
      let dragging = false;

      function saveDrawingSurface() {
        drawingSurfaceImageData = canvas.getImageData(
          0,
          0,
          canvasWidth,
          canvasHeight
        );
      }
      function restoreDrawingSurface() {
        context.putImageData(drawingSurfaceImageData, 0, 0);
      }
      function updateRubberbandRectangle(loc) {
        rubberbandRect.width = Math.abs(loc.x - mousedown.x);
        rubberbandRect.height = Math.abs(loc.y - mousedown.y);
        rubberbandRect.left = Math.min(loc.x, mousedown.x);
        rubberbandRect.top = Math.min(loc.y, mousedown.y);
      }
      function drawRubberbandShape(loc) {
        context.beginPath();
        context.moveTo(mousedown.x, mousedown.y);
        context.lineTo(loc.x, loc.y);
        context.stroke();
      }
      function updateRubberband(loc) {
        updateRubberbandRectangle(loc);
        drawRubberbandShape(loc);
      }

      canvas.onmousedown = function (e) {
        const loc = windowToCanvas(canvas, e.clientX, e.clientY);

        e.preventDefault();
        saveDrawingSurface();
        mousedown.x = loc.x;
        mousedown.y = loc.y;
        dragging = true;
      };
      canvas.onmousemove = function (e) {
        if (dragging) {
          e.preventDefault();
          const loc = windowToCanvas(canvas, e.clientX, e.clientY);
          restoreDrawingSurface();
          updateRubberband(loc);
          if (guidewires) {
            drawGuidewires(loc.x, loc.y);
          }
        }
      };
      canvas.onmouseup = function (e) {
        const loc = windowToCanvas(e.clientX, e.clientY);
        restoreDrawingSurface();
        updateRubberband(loc);
        dragging = false;
      };

      context.strokeStyle = strokeStyleSelect.value;
      drawGrid(context, "lightgray", 10, 10);
    </script>
  </body>
</html>
